<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CA Task & Billing Dashboard</title>
  <link rel="stylesheet" href="style.css">

  <!-- html2canvas + jsPDF for client-side PDF export -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
          onerror="window.__libErr = (window.__libErr||[]).concat('html2canvas load failed')"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
          onerror="window.__libErr = (window.__libErr||[]).concat('jsPDF load failed')"></script>

  <!-- ‚úÖ pdf.js (ESM) with dual-CDN fallback; exposes window.pdfjsLib and sets worker -->
  <script type="module">
    (async () => {
      async function tryImport(from, ver="4.6.82") {
        const base = `${from}/pdfjs-dist@${ver}/build`;
        const pdf = await import(`${base}/pdf.min.mjs`);
        window.pdfjsLib = pdf;
        pdf.GlobalWorkerOptions.workerSrc = `${base}/pdf.worker.min.mjs`;
        window.__pdfWorkerSet = true;
      }
      try { await tryImport("https://unpkg.com"); }
      catch (e1) {
        (window.__libErr = (window.__libErr||[])).push('pdf.js import failed (unpkg): ' + (e1 && e1.message));
        try { await tryImport("https://cdn.jsdelivr.net/npm"); }
        catch (e2) {
          (window.__libErr = (window.__libErr||[])).push('pdf.js import failed (jsDelivr): ' + (e2 && e2.message));
          window.__pdfWorkerSet = false;
        }
      }
    })();
  </script>

  <!-- Tesseract.js for OCR fallback on image-only PDFs -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"
          onerror="window.__libErr = (window.__libErr||[]).concat('tesseract.js load failed')"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <img src="logo.png" alt="Firm Logo" class="logo" />
        <span class="pill">Tasks ‚Ä¢ Deadlines ‚Ä¢ Billings</span>
      </div>
      <div class="actions">
        <button class="btn icon primary" id="addTaskBtn" aria-haspopup="dialog">‚ûï Add Task</button>
        <button class="btn icon" id="createInvoiceBtn" aria-haspopup="dialog">üßæ Create Invoice</button>
        <button class="btn icon ghost" id="bulkDeleteBtn" title="Delete selected">üóëÔ∏è Bulk Delete</button>
        <button class="btn icon ghost" id="exportCsvBtn">‚¨áÔ∏è Export CSV</button>
        <!-- Auth UI -->
        <button class="btn icon" id="signinBtn">üîê Sign in</button>
        <button class="btn icon ghost" id="signoutBtn" style="display:none">‚Ü©Ô∏é Sign out</button>
        <span id="userBadge" style="margin-left:.5rem; font-size:0.9rem; opacity:.8"></span>
        <!-- ‚úÖ Added: Debug toggle to match your JS -->
        <button class="btn icon ghost" id="debugToggleBtn" title="Toggle debug logs">üêû Debug</button>
      </div>
    </header>

    <!-- Filters / Controls -->
    <div class="controls" role="region" aria-label="Filters">
      <div class="field"><input class="input" id="searchInput" placeholder="Search client, task, assignee‚Ä¶" aria-label="Search" /></div>
      <div class="field">
        <select class="select" id="priorityFilter" aria-label="Priority filter">
          <option value="">Priority: All</option>
          <option>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </div>
      <div class="field">
        <input type="hidden" id="statusFilter" value="">
        <div class="multi" id="statusMulti">
          <button type="button" class="btn icon" id="statusMultiBtn">Status: All</button>
          <div class="menu" id="statusMultiMenu" hidden>
            <label><input type="checkbox" value="Not Started"> Not Started</label>
            <label><input type="checkbox" value="In Progress"> In Progress</label>
            <label><input type="checkbox" value="Waiting Client"> Waiting Client</label>
            <label><input type="checkbox" value="On Hold"> On Hold</label>
            <label><input type="checkbox" value="Completed"> Completed</label>
            <div class="menu-actions">
              <button type="button" class="btn ghost" id="statusClearBtn">Clear</button>
              <button type="button" class="btn primary" id="statusApplyBtn">Done</button>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <select class="select" id="assigneeFilter" aria-label="Assignee filter">
          <option value="">In-Charge: All</option>
        </select>
      </div>
      <div class="field">
        <select class="select" id="monthFilter" aria-label="Month filter">
          <option value="">Month: All</option>
        </select>
      </div>
      <div class="field">
        <select class="select" id="sortBy" aria-label="Sort by">
          <option value="deadline">Sort: Deadline</option>
          <option value="createdAt">Sort: Created</option>
          <option value="priority">Sort: Priority</option>
          <option value="status">Sort: Status</option>
          <option value="fee">Sort: Fee</option>
        </select>
      </div>
      <div class="field">
        <select class="select" id="sortDir" aria-label="Sort direction">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
      </div>
    </div>

    <!-- Summary Cards -->
    <section class="grid" aria-label="Summary">
      <div class="card"><h3>Total Tasks</h3><div class="val" id="kpiTotal">0</div></div>
      <div class="card"><h3>Pending</h3><div class="val" id="kpiPending">0</div></div>
      <div class="card"><h3>Overdue</h3><div class="val" id="kpiOverdue">0</div></div>
      <div class="card"><h3>Fee (‚Çπ)</h3><div class="val money" id="kpiFee">0</div></div>
      <div class="card"><h3>Received (‚Çπ)</h3><div class="val money" id="kpiAdv">0</div></div>
      <div class="card"><h3>Outstanding (‚Çπ)</h3><div class="val money" id="kpiOut">0</div></div>
    </section>

    <!-- Table -->
    <table class="table" aria-label="Tasks table">
      <colgroup>
        <col class="col-check">
        <col class="col-client">
        <col class="col-task">
        <col class="col-pri">
        <col class="col-assignee">
        <col class="col-status">
        <col class="col-deadline">
        <col class="col-money">
        <col class="col-money">
        <col class="col-money">
        <col class="col-invoice">
        <col class="col-actions">
      </colgroup>
      <thead class="thead">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Client</th>
          <th>Task</th>
          <th>Priority</th>
          <th>In-Charge</th>
          <th>Status</th>
          <th>Deadline</th>
          <th>Fee</th>
          <th>Received</th>
          <th>Outstanding</th>
          <th>Invoice Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="taskTbody"></tbody>
    </table>

    <footer class="note">Insight at work: organize, analyze, achieve.</footer>
  </div>

  <!-- ===== Modals & A4 invoice template (unchanged) ===== -->
  <!-- ... your task modal / invoice modal / edit invoice modal / A4 template ... -->

  <!-- ‚úÖ Scripts: load your main app first, then Firebase module last -->
  <script src="script.js"></script>
  <script type="module" src="firebase-sync.js"></script>
</body>
</html>
