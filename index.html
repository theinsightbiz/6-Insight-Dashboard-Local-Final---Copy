<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CA Task & Billing Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <!-- Export libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- PDF.js for reading uploaded invoice PDFs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js"></script>
  <script>
    // Ensure the PDF worker is set even under slow networks:
    (function ensurePdfWorker(){
      function setWorker(){
        if (window.pdfjsLib && (!pdfjsLib.GlobalWorkerOptions.workerSrc || !/pdf\.worker/.test(pdfjsLib.GlobalWorkerOptions.workerSrc))) {
          pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";
        }
      }
      document.addEventListener('DOMContentLoaded', setWorker);
      window.addEventListener('load', setWorker);
      setWorker();
    })();
  </script>
  <!-- Tesseract is now lazy-loaded in script.js only when needed -->
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <img src="logo.png" alt="Firm Logo" class="logo" />
        <span class="pill">Tasks ‚Ä¢ Deadlines ‚Ä¢ Billings</span>
      </div>
      <div class="actions">
        <button class="btn icon primary" id="addTaskBtn" aria-haspopup="dialog">‚ûï Add Task</button>
        <button class="btn icon" id="createInvoiceBtn" aria-haspopup="dialog">üßæ Create Invoice</button>
        <button class="btn icon ghost" id="bulkDeleteBtn" title="Delete selected">üóëÔ∏è Bulk Delete</button>
        <button class="btn icon ghost" id="exportCsvBtn">‚¨áÔ∏è Export CSV</button>
        <button class="btn icon ghost" id="resetDemoBtn" title="Loads demo data">üß™ Load Demo</button>
      </div>
    </header>

    <!-- Filters -->
    <div class="controls" role="region" aria-label="Filters">
      <div class="field"><input class="input" id="searchInput" placeholder="Search client, task, assignee‚Ä¶" aria-label="Search" /></div>
      <div class="field">
        <select class="select" id="priorityFilter" aria-label="Priority filter">
          <option value="">Priority: All</option>
          <option>High</option><option>Medium</option><option>Low</option>
        </select>
      </div>
      <div class="field">
        <input type="hidden" id="statusFilter" value="">
        <div class="multi" id="statusMulti">
          <button type="button" class="btn icon" id="statusMultiBtn">Status: All</button>
          <div class="menu" id="statusMultiMenu" hidden>
            <label><input type="checkbox" value="Not Started"> Not Started</label>
            <label><input type="checkbox" value="In Progress"> In Progress</label>
            <label><input type="checkbox" value="Waiting Client"> Waiting Client</label>
            <label><input type="checkbox" value="On Hold"> On Hold</label>
            <label><input type="checkbox" value="Completed"> Completed</label>
            <div class="menu-actions">
              <button type="button" class="btn ghost" id="statusClearBtn">Clear</button>
              <button type="button" class="btn primary" id="statusApplyBtn">Done</button>
            </div>
          </div>
        </div>
      </div>
      <div class="field"><select class="select" id="assigneeFilter"><option value="">In-Charge: All</option></select></div>
      <div class="field"><select class="select" id="monthFilter"><option value="">Month: All</option></select></div>
      <div class="field">
        <select class="select" id="sortBy">
          <option value="deadline">Sort: Deadline</option>
          <option value="createdAt">Sort: Created</option>
          <option value="priority">Sort: Priority</option>
          <option value="status">Sort: Status</option>
          <option value="fee">Sort: Fee</option>
        </select>
      </div>
      <div class="field"><select class="select" id="sortDir"><option value="asc">Asc</option><option value="desc">Desc</option></select></div>
    </div>

    <!-- KPI -->
    <section class="grid" aria-label="Summary">
      <div class="card"><h3>Total Tasks</h3><div class="val" id="kpiTotal">0</div></div>
      <div class="card"><h3>Pending</h3><div class="val" id="kpiPending">0</div></div>
      <div class="card"><h3>Overdue</h3><div class="val" id="kpiOverdue">0</div></div>
      <div class="card"><h3>Fee (‚Çπ)</h3><div class="val money" id="kpiFee">0</div></div>
      <div class="card"><h3>Received (‚Çπ)</h3><div class="val money" id="kpiAdv">0</div></div>
      <div class="card"><h3>Outstanding (‚Çπ)</h3><div class="val money" id="kpiOut">0</div></div>
    </section>

    <!-- Table -->
    <table class="table" aria-label="Tasks table">
      <thead class="thead">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Client</th><th>Task</th><th>Priority</th><th>In-Charge</th>
          <th>Status</th><th>Deadline</th><th>Fee</th><th>Received</th><th>Outstanding</th>
          <th>Invoice Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="taskTbody"></tbody>
    </table>

    <footer class="note">Insight at work: organize, analyze, achieve.</footer>
  </div>

  <!-- Modal: Add/Edit Task -->
  <div class="modal" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
    <div class="dialog">
      <header><h2 id="taskModalTitle">New Task</h2></header>
      <form id="taskForm">
        <div class="body">
          <div class="dialog grid2">
            <div><label>Client Name</label><input required id="fClient"/></div>
            <div><label>Task Title</label><input required id="fTitle"/></div>
            <div><label>Priority</label><select id="fPriority" required><option>High</option><option selected>Medium</option><option>Low</option></select></div>
            <div><label>In-Charge</label><input required id="fAssignee"/></div>
            <div><label>Status</label><select id="fStatus" required><option>Not Started</option><option selected>In Progress</option><option>Waiting Client</option><option>On Hold</option><option>Completed</option></select></div>
            <div><label>Deadline</label><input type="date" id="fDeadline" required/></div>
            <div><label>Fee (‚Çπ)</label><input type="number" step="0.01" min="0" id="fFee" required/></div>
            <div><label>Received (‚Çπ)</label><input type="number" step="0.01" min="0" id="fAdvance" value="0"/></div>
            <div><label>Invoice Status</label><select id="fInvoiceStatus"><option value="">Select status‚Ä¶</option><option>Not Raised</option><option>Sent</option><option>Paid</option><option>Partially Paid</option></select></div>
            <div><label>Notes / Description</label><textarea id="fNotes"></textarea></div>
            <div><label><input type="checkbox" id="fRecurring"/> Recurring monthly</label><small class="hint">Auto-creates monthly instances on the same day.</small></div>
          </div>
        </div>
        <footer><button type="button" class="btn ghost" id="cancelBtn">Cancel</button><button class="btn primary" type="submit" id="saveBtn">Save Task</button></footer>
      </form>
    </div>
  </div>

  <!-- Modal: Create Invoice -->
  <div class="modal" id="invoiceModal" role="dialog" aria-modal="true" aria-labelledby="invoiceModalTitle">
    <div class="dialog">
      <header><h2 id="invoiceModalTitle">Create Invoice</h2></header>
      <form id="invoiceForm">
        <div class="body">
          <div class="dialog grid2">
            <div><label>Invoice No.</label><input id="invNumber" required/></div>
            <div><label>Invoice Date</label><input type="date" id="invDate" required/></div>
            <div><label>Client Name</label><input id="invClient" required/></div>
            <div><label>Mobile No.</label><input id="invMobile"/></div>
            <div><label>Email</label><input id="invEmail" type="email"/></div>
            <div><label>Address</label><textarea id="invAddress"></textarea></div>
          </div>
          <div class="inv-services">
            <div class="inv-services-head">
              <h3>Service Lines</h3>
              <div class="row-actions">
                <button type="button" class="btn" id="addServiceRowBtn">‚ûï Add Row</button>
                <button type="button" class="btn ghost" id="openEditInvoiceBtn" title="Upload an existing invoice to edit">üñäÔ∏è Edit from PDF/Image</button>
              </div>
            </div>
            <div class="inv-grid-head"><span>#</span><span>Description of Service</span><span class="money">Amount (‚Çπ)</span><span>‚Äî</span></div>
            <div id="serviceRows"></div>
            <div class="inv-totals">
              <div class="tot-row"><span>Sub Total</span><span class="money">‚Çπ <span id="subTotal">0</span></span></div>
              <div class="tot-row"><label for="discountInput">Less: Discount</label><input id="discountInput" type="number" min="0" step="0.01" value="0"></div>
              <div class="tot-row strong"><span>Invoice Amount</span><span class="money">‚Çπ <span id="grandTotal">0</span></span></div>
              <div class="tot-row words"><small>Amount (in words): <span id="amountWords">Zero Rupees only</span></small></div>
            </div>
          </div>
        </div>
        <footer>
          <button type="button" class="btn ghost" id="invoiceCancelBtn">Cancel</button>
          <button type="button" class="btn" id="previewInvoiceBtn">Preview</button>
          <button type="button" class="btn primary" id="downloadPdfBtn">Download PDF</button>
        </footer>
      </form>
    </div>
  </div>

  <!-- Modal: Edit Invoice (Upload PDF/Image) -->
  <div class="modal" id="editInvoiceModal" role="dialog" aria-modal="true" aria-labelledby="editInvoiceTitle">
    <div class="dialog">
      <header><h2 id="editInvoiceTitle">Edit Invoice ‚Äì Upload</h2></header>
      <div class="body">
        <div class="edit-grid">
          <div class="uploader" id="pdfDrop">
            <input type="file" id="pdfInput" accept="application/pdf,image/png,image/jpeg" />
            <p><strong>Drop your invoice PDF / image here</strong> or click to select.</p>
            <small>Tip: For fastest parsing, upload a PDF downloaded from this app.</small>
          </div>
          <div class="parse-log" id="parseLog" aria-live="polite"></div>
        </div>
      </div>
      <footer><button type="button" class="btn ghost" id="editCancelBtn">Close</button></footer>
    </div>
  </div>

  <!-- Hidden A4 Invoice Template -->
  <div id="invoiceA4" aria-hidden="true">
    <div class="a4 page">
      <div class="inv-letterhead">
        <div class="lh-left">
          <img src="logo.png" alt="Firm Logo">
          <div class="lh-firm">
            <div class="firm-name">INSIGHT BUSINESS CONSULTANCY</div>
            <div class="firm-sub">A-272, Block A, Surajmal Vihar, New Delhi- 110092</div>
            <div class="firm-sub">Mobile: 9953921244 ‚Ä¢ E-mail: contact@theinsightbiz.com</div>
            <div class="firm-sub">PAN: AAKFI9556M</div>
          </div>
        </div>
        <div class="lh-right">
          <div class="tax-invoice">TAX INVOICE</div>
          <div class="inv-meta">
            <div><strong>Invoice No:</strong> <span data-bind="invNumber"></span></div>
            <div><strong>Invoice Date:</strong> <span data-bind="invDateDDMM"></span></div>
          </div>
        </div>
      </div>

      <div class="inv-billto">
        <div class="box-title">ORIGINAL FOR RECIPIENT</div>
        <div class="bt-grid">
          <div><strong>Detail of Receiver (Billed to Party)</strong></div>
          <div><strong>Invoice Amount</strong></div>
          <div>
            <div><strong>Name:</strong> <span data-bind="client"></span></div>
            <div><strong>Address:</strong> <span data-bind="address"></span></div>
            <div><strong>E-mail:</strong> <span data-bind="email"></span></div>
            <div><strong>Mobile No:</strong> <span data-bind="mobile"></span></div>
          </div>
          <div class="money big">‚Çπ <span data-bind="grandTotal"></span></div>
        </div>
      </div>

      <table class="inv-table">
        <thead>
          <tr><th style="width:40px">S. No.</th><th>Service Description</th><th style="width:160px" class="money">Amount (‚Çπ)</th></tr>
        </thead>
        <tbody data-bind="rows"></tbody>
        <tfoot>
          <tr><th colspan="2" class="right">Sub Total</th><th class="money">‚Çπ <span data-bind="subTotal"></span></th></tr>
          <tr><th colspan="2" class="right">Less: Discount</th><th class="money">‚Çπ <span data-bind="discount"></span></th></tr>
          <tr class="total"><th colspan="2" class="right">Invoice Amount</th><th class="money">‚Çπ <span data-bind="grandTotal"></span></th></tr>
          <tr><td colspan="3" class="words">Invoice Amount (in words): <strong><span data-bind="amountWords"></span></strong></td></tr>
        </tfoot>
      </table>

      <div class="inv-banking">
        <div class="box-title">Banking Details</div>
        <div class="bank-grid">
          <div><strong>Account Holder Name:</strong> Insight Business Consultancy</div>
          <div><strong>Bank Name:</strong> IDFC First Bank</div>
          <div><strong>Bank A/c:</strong> 101 9939 2303</div>
          <div><strong>Bank IFSC:</strong> IDFB 0021 416</div>
        </div>
      </div>

      <div class="inv-terms">
        <div class="box-title">Terms &amp; Conditions</div>
        <ol>
          <li>Amounts must be paid within 03 days.</li>
          <li>May deduct TDS @ 10% as per IT Act u/s 194J.</li>
          <li>E &amp; O Expected.</li>
        </ol>
      </div>
      <div class="inv-note">Note: This is a computer generated invoice and hence does not require a signature.</div>

      <div class="inv-sign">
        <div class="sign-name">Priyam Adarsh</div>
        <div class="sign-title">Partner/ Authorised Signatory</div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
